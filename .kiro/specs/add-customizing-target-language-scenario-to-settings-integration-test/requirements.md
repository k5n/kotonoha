# 要件定義書

## はじめに

本ドキュメントは「設定ページの統合テストに、学習対象言語（learningTargetLanguages）と説明言語（explanationLanguages）のカスタマイズ・シナリオを追加する」ための要求事項を定義する。ここでいう「カスタマイズ」とは、設定ページで言語選択モーダルを用いて言語を追加・削除し、保存後の永続化と再読込時の反映までを含む。

## 用語

- 設定ページ: `src/routes/settings/+page.svelte` の画面。
- 言語選択モーダル: `LanguageSelectionModal.svelte`。検索・チェックボックスで言語を選択するUI。
- 学習対象言語: `Settings.learningTargetLanguages`（BCP47 2文字中心のコード配列）。
- 説明言語: `Settings.explanationLanguages`（同上）。
- 永続化: `settingsRepository.saveSettings()` により `@tauri-apps/plugin-store` 経由で保存されること。

## 機能要件

### R1: 学習対象言語のカスタマイズ

目的: ユーザーは設定ページで学習対象言語を追加・削除できる。

受け入れ条件（R1.x）

1. [表示] 設定ページに現在の学習対象言語がバッジ（言語名ラベル＋削除アイコン）として表示されること。未選択の場合はプレースホルダ文言が表示されること。
2. [追加] 「追加」ボタン押下で言語選択モーダルが開き、一覧が表示されること。チェックを付けた言語は即座に画面の学習対象言語リストへ反映されること（重複追加は発生しない）。
3. [検索] モーダルの検索入力により、表示候補が名称（元名/翻訳名）に部分一致で絞り込まれること。
4. [削除] バッジの削除アイコンを押すと当該言語が選択リストから除去されること。
5. [保存] 「保存」押下で `settingsRepository.saveSettings()` が呼ばれ、選択状態が永続化されること。保存中はボタンが `disabled` になりスピナーが表示されること。
6. [再読込] 保存後に `load()` 相当の再取得を行うと、保存した学習対象言語がそのまま表示に反映されること。

### R2: 説明言語のカスタマイズ

目的: ユーザーは設定ページで説明言語を追加・削除できる。

受け入れ条件（R2.x）

1. [表示] 現在の説明言語がバッジとして表示され、未選択時はプレースホルダ文言が表示されること。
2. [追加] 「追加」ボタンから開く言語選択モーダルにてチェックを付けると即座にリストへ反映され、重複は発生しないこと。
3. [削除] バッジの削除アイコンで当該言語をリストから除去できること。
4. [保存/再読込] 「保存」で永続化され、再取得後も反映されること。

### R3: 表示言語・名称の一貫性

目的: UI表示と言語名称の見え方が一貫する。

受け入れ条件（R3.x）

1. [名称] バッジには `bcp47ToLanguageName()` による英語名を優先表示し、翻訳キーが存在する場合は `i18n` による翻訳名も `LanguageSelectionModal` 内で利用できること。
2. [ラベル] 設定ページの文言は `i18nStore` に基づき英語/日本語で表示できること（既存実装準拠）。

### R4: エラーハンドリングと状態

目的: 保存・読込エラー時の振る舞いが明確である。

受け入れ条件（R4.x）

1. [保存失敗] `saveSettings()` 内で例外が発生した場合、エラーメッセージ（`settings.notifications.saveError`）が表示され、スピナーは停止し、ボタンの `disabled` が解除されること。
2. [読込失敗] `load()` で設定取得に失敗した場合、エラーメッセージ（`settings.notifications.loadError`）が表示されること（既存テストと整合）。

## 非機能/範囲

- 試験種別: ブラウザモード統合テスト（`vitest-browser-svelte`）。Tauri/Stronghold/Store は既存のモック戦略を踏襲する。
- 既存APIキー表示・アプリ情報表示のテストは本シナリオの範囲外（既存テストで担保）。
- 最低選択数等のバリデーションは本要件では規定しない（現行実装に依存）。

## トレーサビリティ（ID）

- R1.1〜R1.6: 学習対象言語の表示/追加/検索/削除/保存/再読込
- R2.1〜R2.4: 説明言語の表示/追加/削除/保存/再読込
- R3.1〜R3.2: 名称・翻訳表示の一貫性
- R4.1〜R4.2: 保存/読込のエラーハンドリング
