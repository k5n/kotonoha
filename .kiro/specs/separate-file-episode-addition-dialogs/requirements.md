# Requirements Document

## Project Description (Input)

EpisodeSourceSelectionModalで先にエピソード追加の方法を選択させることで、ファイルによるエピソード追加を、音声とスクリプト両方のファイルがある場合と、スクリプトのみで音声をTTSで生成する場合のダイアログを分離する

## Introduction

現在のファイルベースエピソード追加では、音声ファイルとスクリプトファイルの両方を用意する場合と、スクリプトファイルのみでTTS音声生成を行う場合が単一のダイアログ内で混在している。この仕様では、EpisodeSourceSelectionModalにファイル追加の詳細選択肢を追加し、各シナリオに特化した独立ダイアログを提供することで、UI複雑性を軽減し、各ワークフローに最適化されたUXを実現する。

## Requirements

### 要件1: ファイル追加方法選択UI

**目的:** ユーザーとして、ファイルベースのエピソード追加時に事前にシナリオを選択したい。これにより、そのシナリオに特化したダイアログで効率的にエピソードを作成できる。

#### 受入基準

1. When ユーザーがEpisodeSourceSelectionModalで「ファイル追加」を選択した場合、Kototohaアプリはファイル追加詳細選択画面を表示する
2. The ファイル追加詳細選択画面は「音声+スクリプトファイル」と「スクリプトファイル+TTS生成」の2つのオプションを提供する
3. When ユーザーが「音声+スクリプトファイル」オプションを選択した場合、Kototohaアプリは音声ファイル付きエピソード追加ダイアログを開く
4. When ユーザーが「スクリプトファイル+TTS生成」オプションを選択した場合、KototohaアプリはTTS音声生成エピソード追加ダイアログを開く
5. When ユーザーがファイル追加詳細選択画面をキャンセルした場合、Kototohaアプリは前の画面に戻る
6. The ファイル追加詳細選択画面は各オプションの違いを分かりやすく説明する

### 要件2: 音声ファイル付きエピソード追加ダイアログ

**目的:** ユーザーとして、音声ファイルとスクリプトファイルの両方を用意している場合の専用ダイアログを使用したい。これにより、TTS関連の設定項目なしで効率的にエピソードを作成できる。

#### 受入基準

1. When ユーザーが「音声+スクリプトファイル」を選択した場合、Kototohaアプリは音声ファイル付きエピソード追加ダイアログを表示する
2. The 音声ファイル付きエピソード追加ダイアログは音声ファイル選択とスクリプトファイル選択の入力要素を含む
3. The 音声ファイル付きエピソード追加ダイアログはTSV設定セクションとスクリプト言語検出機能を含む
4. The 音声ファイル付きエピソード追加ダイアログはTTS関連の設定項目やUI要素を一切含まない
5. When ユーザーが必須ファイルを選択し追加を実行した場合、Kototohaアプリはエピソードを作成しダイアログを閉じる
6. If ファイル選択や処理でエラーが発生した場合、Kototohaアプリは適切なエラーメッセージを表示する
7. The 音声ファイル付きエピソード追加ダイアログは既存のファイル選択UIパターンとTSV設定機能を再利用する

### 要件3: TTS音声生成エピソード追加ダイアログ

**目的:** ユーザーとして、スクリプトファイルのみでTTS音声生成を行う場合の専用ダイアログを使用したい。これにより、音声ファイル関連の設定項目なしで効率的にTTS設定とエピソード作成を行える。

#### 受入基準

1. When ユーザーが「スクリプトファイル+TTS生成」を選択した場合、Kototohaアプリは TTS音声生成エピソード追加ダイアログを表示する
2. The TTS音声生成エピソード追加ダイアログはスクリプトファイル選択の入力要素を含む
3. The TTS音声生成エピソード追加ダイアログはTSV設定セクション、TTS設定セクション、スクリプト言語検出機能を含む
4. The TTS音声生成エピソード追加ダイアログは音声ファイル選択の入力要素を一切含まない
5. When ユーザーがスクリプトファイルとTTS設定を完了し追加を実行した場合、KototohaアプリはTTS音声生成とエピソード作成を実行しダイアログを閉じる
6. If スクリプト処理やTTS生成でエラーが発生した場合、Kototohaアプリは適切なエラーメッセージを表示する
7. The TTS音声生成エピソード追加ダイアログは既存のTTS設定機能とTTS実行フローを再利用する

### 要件4: ダイアログ間の独立性確保

**目的:** 開発者として、音声ファイル付きエピソード追加とTTS音声生成エピソード追加の機能が相互に依存しない実装にしたい。これにより、各シナリオの保守と拡張を独立して行える。

#### 受入基準

1. The 音声ファイル付きエピソード追加ダイアログのストアとロジックはTTS関連のストアやロジックに依存しない
2. The TTS音声生成エピソード追加ダイアログのストアとロジックは音声ファイル関連のストアやロジックに依存しない
3. The 各ダイアログは独立したSvelteコンポーネントとして実装される
4. The 各ダイアログは独立したストア（`audioFileEpisodeAddStore`、`ttsEpisodeAddStore`など）を使用する
5. When いずれかのダイアログでエラーが発生した場合、他方のダイアログの状態に影響を与えない
6. The 各ダイアログは`addNewEpisode`ユースケースの適切なパラメータバリアントを呼び出す

### 要件5: 既存FileEpisodeAddModalの段階的移行

**目的:** 開発者として、既存の`FileEpisodeAddModal`から新しい2つのダイアログへの段階的移行を行いたい。これにより、既存機能を破損させることなく新しいアーキテクチャに移行できる。

#### 受入基準

1. When 移行フェーズ1では、既存の`FileEpisodeAddModal`は新しいダイアログ選択フローに置き換えられる
2. The 既存の`fileEpisodeAddStore.svelte.ts`は新しいダイアログ専用ストアに分割される
3. The 既存のTSV設定とTTS設定コンポーネントは新しいダイアログで再利用される
4. When 移行完了後、不要になった統合型コンポーネントとストアは削除される
5. The 移行過程でのAPI契約変更は最小限に抑制される
6. If 移行中に既存テストが失敗する場合、適切な修正または新しいテストケースで対応する

### 要件6: 既存機能との互換性維持

**目的:** ユーザーとして、リファクタリング後も従来と同等の機能を使用したい。これにより、機能の削減なしに改善されたUXを享受できる。

#### 受入基準

1. The 新しいダイアログ群は既存の`addNewEpisode`ユースケースと同じAPI契約を維持する
2. The 音声ファイル付きエピソード追加は既存のファイル選択とTSV設定機能を完全にサポートする
3. The TTS音声生成エピソード追加は既存のTTS設定、音声生成、エピソード作成機能を完全にサポートする
4. The 作成されるエピソードデータは既存の形式と完全に互換性を持つ
5. When リファクタリング完了後、関連する既存のテストケースは引き続き合格する
6. The データベーススキーマや ファイル保存形式に変更は発生しない
